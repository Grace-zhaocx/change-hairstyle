# AI智能换发型网站 - 技术设计文档

## 1. 系统架构设计

### 1.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            用户界面层 (Frontend)                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│  React 18 + TypeScript + Ant Design + Fabric.js                                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │
│  │  图片上传   │ │  发型选择   │ │  效果预览   │ │  结果管理   │               │
│  │   组件      │ │   组件      │ │   组件      │ │   组件      │               │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                           API网关层 (API Gateway)                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                           业务逻辑层 (Backend)                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│  FastAPI + Python                                                              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │
│  │  用户管理   │ │  图片处理   │ │  任务调度   │ │  结果管理   │               │
│  │   服务      │ │   服务      │ │   服务      │ │   服务      │               │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                          AI处理层 (AI Processing)                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │
│  │  人脸检测   │ │  头发分割   │ │  发型生成   │ │  图像融合   │               │
│  │   服务      │ │   服务      │ │   服务      │ │   服务      │               │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                          数据存储层 (Data Storage)                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │
│  │ PostgreSQL  │ │    Redis    │ │  文件存储   │ │  模型存储   │               │
│  │   数据库    │ │   缓存      │ │   系统      │ │   系统      │               │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘               │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 微服务架构

```
                    ┌─────────────────┐
                    │   Load Balancer │
                    │    (Nginx)      │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │  API Gateway    │
                    │   (FastAPI)     │
                    └─────────┬───────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
┌───────▼───────┐    ┌────────▼────────┐    ┌───────▼───────┐
│  User Service │    │ Image Service   │    │ AI Service     │
│   (用户管理)   │    │   (图片处理)    │    │  (AI处理)      │
└───────┬───────┘    └────────┬────────┘    └───────┬───────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
                    ┌─────────▼───────┐
                    │  Message Queue  │
                    │   (Celery)      │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │   Database      │
                    │ PostgreSQL +    │
                    │ Redis + MinIO   │
                    └─────────────────┘
```

---

## 2. API接口设计

### 2.1 RESTful API 规范

#### 基础配置
```
Base URL: https://api.hairstyle-ai.com/v1
Content-Type: application/json
Authentication: Bearer Token
```

#### 通用响应格式
```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": "2025-10-11T10:30:00Z",
  "request_id": "req_123456789"
}
```

### 2.2 核心API接口

#### 2.2.1 用户相关接口

```yaml
# 用户注册
POST /auth/register
{
  "username": "string",
  "email": "string",
  "password": "string"
}

# 用户登录
POST /auth/login
{
  "email": "string",
  "password": "string"
}

# 获取用户信息
GET /users/profile
Authorization: Bearer {token}

# 更新用户信息
PUT /users/profile
Authorization: Bearer {token}
{
  "avatar": "string",
  "preferences": {}
}
```

#### 2.2.2 图片处理接口

```yaml
# 上传原始图片
POST /images/upload
Authorization: Bearer {token}
Content-Type: multipart/form-data
{
  "image": "file",
  "description": "string"
}

# 获取图片信息
GET /images/{image_id}
Authorization: Bearer {token}

# 删除图片
DELETE /images/{image_id}
Authorization: Bearer {token}
```

#### 2.2.3 发型处理接口

```yaml
# 文本描述换发型
POST /hairstyle/text-to-hair
Authorization: Bearer {token}
{
  "image_id": "string",
  "description": {
    "length": "short|medium|long",
    "style": "straight|wavy|curly",
    "color": "natural|brown|blonde|custom",
    "custom_description": "string"
  },
  "parameters": {
    "blend_strength": 0.85,
    "edge_smoothing": 0.7,
    "lighting_match": 0.6
  }
}

# 参考图片换发型
POST /hairstyle/reference-to-hair
Authorization: Bearer {token}
Content-Type: multipart/form-data
{
  "target_image": "file",
  "reference_image": "file",
  "parameters": {}
}

# 获取处理状态
GET /hairstyle/tasks/{task_id}
Authorization: Bearer {token}

# 取消处理任务
DELETE /hairstyle/tasks/{task_id}
Authorization: Bearer {token}
```

#### 2.2.4 结果管理接口

```yaml
# 获取处理结果
GET /hairstyle/results/{result_id}
Authorization: Bearer {token}

# 下载结果图片
GET /hairstyle/results/{result_id}/download
Authorization: Bearer {token}

# 分享结果
POST /hairstyle/results/{result_id}/share
Authorization: Bearer {token}
{
  "share_type": "public|private",
  "expires_in": 3600
}

# 获取历史记录
GET /hairstyle/history
Authorization: Bearer {token}
Query Parameters:
- page: integer
- limit: integer
- sort: "created_at|updated_at"
- order: "asc|desc"
```

### 2.3 WebSocket 接口

```yaml
# 实时处理状态推送
WS /ws/hairstyle/{task_id}
Authorization: Bearer {token}

消息格式:
{
  "type": "progress|status|error|complete",
  "data": {
    "progress": 75,
    "stage": "hairstyle_generation",
    "message": "正在生成发型...",
    "estimated_time": 15
  }
}
```

---

## 3. 数据库设计

### 3.1 数据库选择

**主数据库**: PostgreSQL 14+
**缓存数据库**: Redis 7+
**文件存储**: MinIO (S3兼容)

### 3.2 表结构设计

#### 3.2.1 用户表 (users)

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    avatar_url VARCHAR(500),
    status VARCHAR(20) DEFAULT 'active',
    preferences JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_login_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status ON users(status);
```

#### 3.2.2 图片表 (images)

```sql
CREATE TABLE images (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    original_filename VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size INTEGER NOT NULL,
    width INTEGER NOT NULL,
    height INTEGER NOT NULL,
    format VARCHAR(10) NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    md5_hash VARCHAR(32) NOT NULL,
    face_detected BOOLEAN DEFAULT FALSE,
    face_bbox JSONB,
    status VARCHAR(20) DEFAULT 'uploaded',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_images_user_id ON images(user_id);
CREATE INDEX idx_images_status ON images(status);
CREATE INDEX idx_images_created_at ON images(created_at);
```

#### 3.2.3 发型任务表 (hairstyle_tasks)

```sql
CREATE TABLE hairstyle_tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    source_image_id UUID NOT NULL REFERENCES images(id),
    reference_image_id UUID REFERENCES images(id),
    task_type VARCHAR(20) NOT NULL, -- 'text' or 'reference'
    input_params JSONB NOT NULL,
    status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'processing', 'completed', 'failed', 'cancelled'
    progress INTEGER DEFAULT 0,
    current_stage VARCHAR(50),
    error_message TEXT,
    processing_time INTEGER,
    result_id UUID REFERENCES hairstyle_results(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    started_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_hairstyle_tasks_user_id ON hairstyle_tasks(user_id);
CREATE INDEX idx_hairstyle_tasks_status ON hairstyle_tasks(status);
CREATE INDEX idx_hairstyle_tasks_created_at ON hairstyle_tasks(created_at);
```

#### 3.2.4 发型结果表 (hairstyle_results)

```sql
CREATE TABLE hairstyle_results (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    task_id UUID NOT NULL REFERENCES hairstyle_tasks(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    source_image_id UUID NOT NULL REFERENCES images(id),
    result_image_id UUID NOT NULL REFERENCES images(id),
    result_params JSONB,
    quality_score DECIMAL(3,2),
    user_rating INTEGER CHECK (user_rating >= 1 AND user_rating <= 5),
    user_feedback TEXT,
    share_token VARCHAR(100) UNIQUE,
    share_expires_at TIMESTAMP WITH TIME ZONE,
    download_count INTEGER DEFAULT 0,
    view_count INTEGER DEFAULT 0,
    is_public BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_hairstyle_results_user_id ON hairstyle_results(user_id);
CREATE INDEX idx_hairstyle_results_share_token ON hairstyle_results(share_token);
CREATE INDEX idx_hairstyle_results_is_public ON hairstyle_results(is_public);
```

#### 3.2.5 系统配置表 (system_configs)

```sql
CREATE TABLE system_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value JSONB NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

INSERT INTO system_configs (config_key, config_value, description) VALUES
('max_file_size', '10485760', '最大文件上传大小(字节)'),
('supported_formats', '["jpg", "jpeg", "png", "webp"]', '支持的图片格式'),
('default_processing_params', '{"blend_strength": 0.85, "edge_smoothing": 0.7, "lighting_match": 0.6}', '默认处理参数'),
('rate_limits', '{"upload_per_hour": 20, "process_per_day": 50}', '频率限制配置');
```

---

## 4. AI模型集成方案

### 4.1 模型架构

```
输入图片 → 人脸检测 → 头发分割 → 特征提取 → 发型生成 → 图像融合 → 输出图片
    ↓           ↓           ↓           ↓           ↓           ↓
RetinaFace   SegFormer   CLIP        Stable      ControlNet  后处理
             BISENet                 Diffusion
```

### 4.2 模型详细配置

#### 4.2.1 人脸检测模型

```yaml
model: "RetinaFace"
framework: "PyTorch"
input_size: [640, 640]
confidence_threshold: 0.9
nms_threshold: 0.4
device: "cuda:0"
model_path: "/models/retinaface_mobilenet.pth"
```

#### 4.2.2 头发分割模型

```yaml
model: "SegFormer-B2"
framework: "PyTorch + Transformers"
input_size: [512, 512]
num_classes: 19  # hair, face, background, etc.
device: "cuda:0"
model_path: "/models/segformer_hair_segmentation.pth"
```

#### 4.2.3 发型生成模型

```yaml
model: "Stable Diffusion v1.5"
framework: "PyTorch + Diffusers"
scheduler: "DPMSolverMultistepScheduler"
guidance_scale: 7.5
num_inference_steps: 20
device: "cuda:0"
model_path: "/models/stable-diffusion-v1-5"
controlnet_path: "/models/controlnet-face-cogvideox-2b"
```

### 4.3 处理流程

```python
class HairstyleProcessor:
    def __init__(self):
        self.face_detector = RetinaFaceDetector()
        self.hair_segmenter = SegFormerSegmenter()
        self.hairstyle_generator = StableDiffusionGenerator()
        self.image_fusion = ImageFusion()

    async def process_text_to_hair(self, image_path: str, description: dict) -> str:
        # 1. 人脸检测
        face_info = await self.face_detector.detect(image_path)

        # 2. 头发分割
        hair_mask = await self.hair_segmenter.segment(image_path)

        # 3. 构建提示词
        prompt = self.build_prompt(description, face_info)

        # 4. 生成新发型
        generated_hair = await self.hairstyle_generator.generate(
            image_path=image_path,
            mask=hair_mask,
            prompt=prompt,
            control_image=image_path
        )

        # 5. 图像融合
        result = await self.image_fusion.blend(
            original_image=image_path,
            generated_hair=generated_hair,
            mask=hair_mask,
            blend_strength=description.get('blend_strength', 0.85)
        )

        return result
```

### 4.4 性能优化

#### 4.4.1 模型量化
```python
# 使用半精度推理减少显存占用
model = model.half()
# 使用ONNX Runtime加速推理
import onnxruntime as ort
ort_session = ort.InferenceSession("model.onnx")
```

#### 4.4.2 批处理优化
```python
# 支持批量处理提高吞吐量
async def batch_process(self, image_paths: List[str], descriptions: List[dict]):
    batch_size = 4
    results = []
    for i in range(0, len(image_paths), batch_size):
        batch_images = image_paths[i:i+batch_size]
        batch_desc = descriptions[i:i+batch_size]
        batch_results = await self.process_batch(batch_images, batch_desc)
        results.extend(batch_results)
    return results
```

---

## 5. 技术栈配置

### 5.1 前端技术栈

```json
{
  "framework": "React 18.2.0",
  "language": "TypeScript 5.0+",
  "ui_library": "Ant Design 5.0+",
  "state_management": "Redux Toolkit + RTK Query",
  "routing": "React Router 6.0+",
  "styling": "Styled-components + CSS Modules",
  "image_processing": "Fabric.js + Konva.js",
  "http_client": "Axios",
  "websocket": "Socket.io-client",
  "build_tool": "Vite",
  "testing": "Jest + React Testing Library",
  "bundler": "Rollup (via Vite)"
}
```

#### 前端依赖配置 (package.json)

```json
{
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "typescript": "^5.0.0",
    "antd": "^5.0.0",
    "@reduxjs/toolkit": "^1.9.0",
    "react-redux": "^8.0.0",
    "react-router-dom": "^6.0.0",
    "styled-components": "^6.0.0",
    "fabric": "^5.0.0",
    "konva": "^9.0.0",
    "react-konva": "^18.0.0",
    "axios": "^1.6.0",
    "socket.io-client": "^4.7.0",
    "react-dropzone": "^14.0.0",
    "react-image-crop": "^11.0.0",
    "react-compare-image": "^3.0.0",
    "framer-motion": "^10.0.0",
    "react-hot-toast": "^2.4.0"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.0.0",
    "vite": "^4.4.0",
    "@types/react": "^18.2.0",
    "@types/react-dom": "^18.2.0",
    "@types/fabric": "^5.0.0",
    "eslint": "^8.45.0",
    "@typescript-eslint/eslint-plugin": "^6.0.0",
    "@typescript-eslint/parser": "^6.0.0",
    "prettier": "^3.0.0"
  }
}
```

### 5.2 后端技术栈

```python
{
  "framework": "FastAPI 0.104+",
  "language": "Python 3.9+",
  "async_runtime": "Uvicorn",
  "orm": "SQLAlchemy 2.0+",
  "database": "PostgreSQL 14+",
  "cache": "Redis 7+",
  "file_storage": "MinIO",
  "task_queue": "Celery + Redis",
  "ai_frameworks": [
    "PyTorch 2.0+",
    "Transformers 4.35+",
    "Diffusers 0.24+",
    "OpenCV-Python 4.8+",
    "Pillow 10.0+"
  ],
  "monitoring": "Prometheus + Grafana",
  "logging": "Loguru",
  "testing": "Pytest + pytest-asyncio"
}
```

#### 后端依赖配置 (requirements.txt)

```txt
# Web Framework
fastapi==0.104.1
uvicorn[standard]==0.24.0
python-multipart==0.0.6

# Database
sqlalchemy==2.0.23
asyncpg==0.29.0
alembic==1.12.1

# Cache & Queue
redis==5.0.1
celery==5.3.4

# AI/ML
torch==2.1.1
torchvision==0.16.1
transformers==4.35.2
diffusers==0.24.0
accelerate==0.24.1
opencv-python==4.8.1.78
Pillow==10.1.0
numpy==1.24.4

# File Storage
minio==7.2.0

# Utilities
pydantic==2.5.0
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
python-dotenv==1.0.0
loguru==0.7.2
prometheus-client==0.19.0

# Development
pytest==7.4.3
pytest-asyncio==0.21.1
black==23.11.0
isort==5.12.0
mypy==1.7.1
```

### 5.3 Docker 配置

#### Dockerfile (Backend)

```dockerfile
FROM python:3.9-slim

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    libgl1-mesa-glx \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    wget \
    && rm -rf /var/lib/apt/lists/*

# 设置工作目录
WORKDIR /app

# 安装Python依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 下载模型文件
RUN python scripts/download_models.py

# 暴露端口
EXPOSE 8000

# 启动命令
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

#### docker-compose.yml

```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:password@db:5432/hairstyle_db
      - REDIS_URL=redis://redis:6379
      - MINIO_ENDPOINT=minio:9000
    depends_on:
      - db
      - redis
      - minio
    volumes:
      - ./models:/app/models
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:8000
    depends_on:
      - backend

  worker:
    build: ./backend
    command: celery -A app.celery worker --loglevel=info
    environment:
      - DATABASE_URL=postgresql://user:password@db:5432/hairstyle_db
      - REDIS_URL=redis://redis:6379
    depends_on:
      - db
      - redis
    volumes:
      - ./models:/app/models

  db:
    image: postgres:14
    environment:
      - POSTGRES_DB=hairstyle_db
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - frontend
      - backend

volumes:
  postgres_data:
  minio_data:
```

### 5.4 开发工具配置

#### ESLint 配置 (.eslintrc.js)

```javascript
module.exports = {
  extends: [
    'eslint:recommended',
    '@typescript-eslint/recommended',
    'react-app',
    'react-app/jest'
  ],
  parser: '@typescript-eslint/parser',
  plugins: ['@typescript-eslint'],
  rules: {
    '@typescript-eslint/no-unused-vars': 'error',
    '@typescript-eslint/explicit-function-return-type': 'warn',
    'react-hooks/exhaustive-deps': 'warn'
  }
};
```

#### Prettier 配置 (.prettierrc)

```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 80,
  "tabWidth": 2,
  "useTabs": false
}
```

#### Black 配置 (pyproject.toml)

```toml
[tool.black]
line-length = 88
target-version = ['py39']
include = '\.pyi?$'
extend-exclude = '''
/(
  # directories
  \.eggs
  | \.git
  | \.hg
  | \.mypy_cache
  | \.tox
  | \.venv
  | build
  | dist
)/
'''
```

---

## 6. 部署和运维

### 6.1 环境配置

#### 开发环境 (.env.development)

```env
# Database
DATABASE_URL=postgresql://dev_user:dev_pass@localhost:5432/hairstyle_dev
REDIS_URL=redis://localhost:6379

# Storage
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
MINIO_BUCKET_NAME=hairstyle-dev

# Security
SECRET_KEY=dev-secret-key-change-in-production
JWT_ALGORITHM=HS256
JWT_EXPIRE_MINUTES=1440

# AI Models
MODEL_CACHE_DIR=/app/models
DEFAULT_DEVICE=cuda

# Monitoring
LOG_LEVEL=DEBUG
PROMETHEUS_PORT=9090
```

#### 生产环境 (.env.production)

```env
# Database
DATABASE_URL=postgresql://prod_user:secure_pass@db:5432/hairstyle_prod
REDIS_URL=redis://redis:6379

# Storage
MINIO_ENDPOINT=minio:9000
MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
MINIO_BUCKET_NAME=hairstyle-prod

# Security
SECRET_KEY=${SECRET_KEY}
JWT_ALGORITHM=HS256
JWT_EXPIRE_MINUTES=1440

# AI Models
MODEL_CACHE_DIR=/app/models
DEFAULT_DEVICE=cuda

# Monitoring
LOG_LEVEL=INFO
PROMETHEUS_PORT=9090

# Performance
MAX_WORKERS=4
WORKER_TIMEOUT=300
MAX_CONCURRENT_TASKS=10
```

### 6.2 监控和日志

#### Prometheus 配置 (prometheus.yml)

```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'hairstyle-backend'
    static_configs:
      - targets: ['backend:8000']
    metrics_path: '/metrics'

  - job_name: 'hairstyle-worker'
    static_configs:
      - targets: ['worker:9090']

  - job_name: 'redis'
    static_configs:
      - targets: ['redis:6379']

  - job_name: 'postgres'
    static_configs:
      - targets: ['db:5432']
```

#### 日志配置

```python
from loguru import logger
import sys

# 移除默认处理器
logger.remove()

# 添加控制台输出
logger.add(
    sys.stdout,
    format="<green>{time:YYYY-MM-DD HH:mm:ss}</green> | <level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>",
    level="INFO"
)

# 添加文件输出
logger.add(
    "logs/hairstyle_{time:YYYY-MM-DD}.log",
    rotation="1 day",
    retention="30 days",
    format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {name}:{function}:{line} - {message}",
    level="DEBUG"
)

# 添加错误日志
logger.add(
    "logs/error_{time:YYYY-MM-DD}.log",
    rotation="1 day",
    retention="30 days",
    format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {name}:{function}:{line} - {message}",
    level="ERROR"
)
```

### 6.3 备份策略

#### 数据库备份脚本

```bash
#!/bin/bash
# backup_database.sh

DB_NAME="hairstyle_prod"
DB_USER="postgres"
BACKUP_DIR="/backups/database"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行备份
pg_dump -h localhost -U $DB_USER -d $DB_NAME | gzip > $BACKUP_DIR/backup_$DATE.sql.gz

# 清理30天前的备份
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +30 -delete

echo "Database backup completed: backup_$DATE.sql.gz"
```

#### 文件备份脚本

```bash
#!/bin/bash
# backup_files.sh

SOURCE_DIR="/app/storage"
BACKUP_DIR="/backups/files"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行备份
rsync -av --delete $SOURCE_DIR/ $BACKUP_DIR/current/

# 创建增量备份
cp -al $BACKUP_DIR/current $BACKUP_DIR/backup_$DATE

echo "Files backup completed: backup_$DATE"
```

---

## 7. 安全和性能

### 7.1 安全配置

#### API限流

```python
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@app.post("/images/upload")
@limiter.limit("20/minute")
async def upload_image(request: Request, ...):
    pass

@app.post("/hairstyle/process")
@limiter.limit("10/hour")
async def process_hairstyle(request: Request, ...):
    pass
```

#### 输入验证

```python
from pydantic import BaseModel, validator
import magic

class ImageUploadRequest(BaseModel):
    filename: str
    file_size: int

    @validator('filename')
    def validate_filename(cls, v):
        allowed_extensions = ['.jpg', '.jpeg', '.png', '.webp']
        if not any(v.lower().endswith(ext) for ext in allowed_extensions):
            raise ValueError('Invalid file extension')
        return v

    @validator('file_size')
    def validate_file_size(cls, v):
        max_size = 10 * 1024 * 1024  # 10MB
        if v > max_size:
            raise ValueError('File too large')
        return v
```

### 7.2 性能优化

#### 缓存策略

```python
import redis
from fastapi import Cache

# Redis缓存配置
cache = Cache(redis.Redis(host='redis', port=6379, db=0))

@cache(expire=3600)  # 缓存1小时
async def get_user_hairstyle_history(user_id: str):
    # 获取用户发型历史
    pass

@cache(expire=86400)  # 缓存24小时
async def get_recommended_hairstyles(user_preferences: dict):
    # 获取推荐发型
    pass
```

#### 数据库优化

```sql
-- 创建复合索引
CREATE INDEX idx_hairstyle_tasks_user_status_created
ON hairstyle_tasks(user_id, status, created_at);

-- 分区表
CREATE TABLE hairstyle_results_2024 PARTITION OF hairstyle_results
FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');

-- 查询优化
EXPLAIN ANALYZE
SELECT * FROM hairstyle_results
WHERE user_id = 'user123'
ORDER BY created_at DESC
LIMIT 10;
```

---

## 8. 测试策略

### 8.1 单元测试

```python
# tests/test_image_processor.py
import pytest
from app.services.image_processor import ImageProcessor

@pytest.fixture
def image_processor():
    return ImageProcessor()

@pytest.mark.asyncio
async def test_detect_face(image_processor):
    result = await image_processor.detect_face("test_images/face.jpg")
    assert result['faces_detected'] == 1
    assert 'bbox' in result

@pytest.mark.asyncio
async def test_segment_hair(image_processor):
    result = await image_processor.segment_hair("test_images/person.jpg")
    assert result['mask_shape'] == (512, 512)
    assert 'hair_region' in result
```

### 8.2 集成测试

```python
# tests/test_api_integration.py
import pytest
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_complete_hairstyle_workflow():
    # 1. 用户注册登录
    register_response = client.post("/auth/register", json={
        "username": "testuser",
        "email": "test@example.com",
        "password": "testpass123"
    })
    assert register_response.status_code == 200

    # 2. 上传图片
    with open("test_images/sample.jpg", "rb") as f:
        upload_response = client.post(
            "/images/upload",
            files={"image": ("sample.jpg", f, "image/jpeg")},
            headers={"Authorization": f"Bearer {token}"}
        )
    assert upload_response.status_code == 200

    # 3. 处理发型
    process_response = client.post(
        "/hairstyle/text-to-hair",
        json={
            "image_id": upload_response.json()["data"]["id"],
            "description": {
                "length": "medium",
                "style": "wavy",
                "color": "brown"
            }
        },
        headers={"Authorization": f"Bearer {token}"}
    )
    assert process_response.status_code == 200

    # 4. 获取结果
    task_id = process_response.json()["data"]["task_id"]
    result_response = client.get(
        f"/hairstyle/tasks/{task_id}",
        headers={"Authorization": f"Bearer {token}"}
    )
    assert result_response.status_code == 200
```

### 8.3 性能测试

```python
# tests/test_performance.py
import pytest
import asyncio
import time
from app.services.hairstyle_processor import HairstyleProcessor

@pytest.mark.asyncio
async def test_batch_processing_performance():
    processor = HairstyleProcessor()

    # 准备测试数据
    test_images = ["test_image_1.jpg", "test_image_2.jpg", "test_image_3.jpg"]
    test_descriptions = [
        {"length": "short", "style": "straight"},
        {"length": "medium", "style": "wavy"},
        {"length": "long", "style": "curly"}
    ]

    # 测试批量处理性能
    start_time = time.time()
    results = await processor.batch_process(test_images, test_descriptions)
    end_time = time.time()

    processing_time = end_time - start_time
    assert processing_time < 120  # 应该在2分钟内完成
    assert len(results) == 3
    assert all(result['status'] == 'completed' for result in results)
```

---

## 9. 总结

本技术设计文档为AI智能换发型网站提供了完整的技术架构和实现方案：

### 核心特点：
1. **微服务架构** - 模块化设计，易于扩展和维护
2. **异步处理** - 基于FastAPI和Celery的高性能异步架构
3. **AI优化** - 针对换发型场景优化的模型集成方案
4. **高可用性** - 完善的监控、备份和错误处理机制
5. **安全可靠** - 全面的安全防护和性能优化策略

### 技术优势：
- **性能优秀** - 支持并发处理，响应速度快
- **扩展性强** - 支持水平扩展和模型升级
- **开发友好** - 完整的开发工具链和测试框架
- **运维便利** - Docker化部署，自动化运维

这个技术方案为开发团队提供了清晰的实现路径，确保项目能够高质量、高效率地完成开发和部署。